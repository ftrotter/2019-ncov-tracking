---
title: "COVID-19 Around the World"
author: "Chris Berg"
date: <br>`r format(Sys.Date(), '%d %B %Y') `
output: 
  html_document:
    theme: yeti
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

if(!require(pacman)) install.packages("pacman")
pacman::p_load( tidyverse ,
                ggplot2  ,
                lubridate,
                sf ,
                maps ,
                leaflet, 
                hrbrthemes , 
                plotly )

world_data = 
  readRDS("data/export/worldwide_data.rds") %>%
  filter( province_state != "Diamond Princess") %>%
  pivot_wider( names_from = type , 
               values_from = cases ) %>%
  rename(cases = `Confirmed Cases` , 
         deaths = Death ) %>%
  mutate( cfr = deaths/cases )

```

The data used here comes from the [Johns Hopkins University Center for Systems Science and Engineering GitHub repo](https://github.com/CSSEGISandData/COVID-19) which is updated daily. Updates to this page will occur as soon as they can after the JHU data gets updated.

## Interactive world map of COVID-19


```{r worldmap-data, include=F}

world_today = 
  world_data %>%
  filter( date == ymd(max(date)))

world  = 
  st_as_sf(map("world", plot = FALSE, fill = TRUE)) %>% 
  st_transform( crs = 4326 )

proj_crs = st_crs(world)

world_sf = 
  world_today %>% 
  st_as_sf( coords = c("long","lat") ,
            crs = 4326 )

gr = 
  st_graticule(lat = c(-89.9,seq(-80,80,20),89.9) , 
               crs = 4326)

```

Below is an interactive world map, highlighting the cases, deaths, and case fatality ratios of COVID-19 (a.k.a. coronavirus or novel coronavirus ) within countries and provinces. Larger red circles indicate a greater number of Coronavirus cases in the area, and clicking on the red circles gives the name of the area it represents, their number of cases and deaths which have been confirmed, as well as the "case fatality ratio" (ratio of deaths to confirmed cases). *Tip: Use the drag and zoom features to select and enlarge regions of the map.*

```{r worldmap-int, echo=F , fig.align='center'}

world_sf %>% 
  filter( cases > 0 ) %>%
  st_transform(crs = "+init=epsg:4326") %>%
  leaflet(width = "100%") %>% 
  addProviderTiles(provider = "CartoDB.Positron") %>%
  addCircleMarkers( radius = ~log(cases) , 
                    popup = ~paste0(paste(province_state, country_region , sep = ", ") , 
                                    "<br>", "Confirmed Cases: ", prettyNum(cases, big.mark=",") , 
                                    "<br>", "Deaths: " , prettyNum(deaths, big.mark=",") , 
                                    "<br>", "Case fatality ratio: " , prettyNum(round(cfr,3))),
                    color = 'red' , 
                    stroke = F ) 

```


## COVID-19 cases and deaths over time

```{r data-plot, include=F}

country_df = 
  world_data %>%
  group_by( country_region , date) %>%
  summarise( cases = sum(cases) , 
             deaths = sum(deaths) )


cases_plot = 
  country_df %>%
  ggplot( ) + 
  geom_line( aes( x = date , y = cases , color = country_region ) ) + 
  labs( title = "COVID-19 cases worldwide" , 
        x = "Date" , 
        y = " Confirmed Cases" , 
        color = "Country" ) +
  theme_ipsum_rc( axis_title_size = 15 )

deaths_plot = 
  country_df %>%
  ggplot( ) + 
  geom_line( aes( x = date , y = deaths , color = country_region ) ) + 
  labs( title = "COVID-19 deaths worldwide" , 
        x = "Date" , 
        y = " Deaths" , 
        color = "Country" ) +
  theme_ipsum_rc( axis_title_size = 15 )

```

The novel coronavirus has overwhelmed nations with exponential growth. Below, interactive graphs show these exponential growth curves in each country. Double-click the country name in the legend to the right of the chart in order to single-out that country's growth curve. Any number of countries are able to be selected and compared.

```{r int-plot, echo=FALSE, dpi = 120 }

plotly::ggplotly( cases_plot
                  )

```

```{r int-deaths-plot, echo=FALSE, dpi = 120 }

plotly::ggplotly( deaths_plot
                  )

```