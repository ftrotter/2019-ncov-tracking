---
title: "SARS-CoV-2 among US counties"
author: "Chris Berg"
date: <br>`r format(Sys.Date() , "%d %B %Y")`
output: 
  html_document:
    theme: yeti
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

if(!require(pacman)) install.packages("pacman")
pacman::p_load( tidyverse ,  
                sf , 
                lubridate ,
                tigris ,
                leaflet ,
                RColorBrewer )

recent_date = format(Sys.Date()-days(1) , "%m-%d-%Y")

```

## US counties

```{r datasets, include=F}


options(tigris_class = "sf")
us_counties_map = 
  tigris::counties(cb = T ) 


most_recent_data = 
  readRDS( paste0("data/export/us-county-data-updated-" , Sys.Date()-days(1) , ".rds" ,sep = "")
  ) %>%
  filter( last_update == mdy(recent_date) & fips < 60000 ) %>%
  mutate( GEOID = ifelse( fips < 10000 , 
                          paste(0,fips,sep="") , 
                          fips ) ,
          cfr = deaths/confirmed
          ) %>%
  select(GEOID , confirmed, deaths , cfr)


us_counties = 
  left_join( most_recent_data , us_counties_map ) %>%
  st_as_sf()

```

The map below uses comprehensive public data on COVID-19 cases and deaths among the United States counties. The map is fully-interactive; you can zoom, pan, and click on the US counties to see information on their confirmed case counts, death counts, and their *case fatality ratio* (the ratio of deaths to confirmed cases).

*Note: Data in New York City are (inexplicably) rendered for Manhattan island, not for the other boroughs. Zoom in on the island to check the NYC case and death counts.*

Updated as of `r format(Sys.Date() , "%d %B %Y")`.


## Confirmed Coronavirus cases and deaths in US counties


```{r casesmap, echo=FALSE}


col_pal <- colorNumeric(palette = "YlOrRd", domain = log(1+us_counties$confirmed), n = 10)

county_plot = 
  us_counties %>%
  st_transform(crs = "+init=epsg:4326") %>%
  leaflet(width = "100%") %>% 
  addProviderTiles(provider = "CartoDB.Positron") %>%
  addPolygons(
    popup = ~paste0(NAME, 
                    "<br>", "Confirmed cases: ", prettyNum(confirmed, big.mark=","), 
                    "<br>", "Deaths: ", prettyNum(deaths, big.mark=",") , 
                    "<br>" , "Case fatality ratio: ", prettyNum(round(cfr,3), big.mark=",") ),
    stroke = FALSE,
    smoothFactor = 0,
    fillOpacity = 0.7,
    color = ~col_pal(log(1+confirmed))
  ) %>%
  addLegend(
    "bottomright", 
    pal = col_pal, 
    values = ~log(1+confirmed),
    title = "Confirmed Cases (Logarithm)",
    opacity = 1
  ) %>% 
  setView(lat=40, lng=-95, zoom=3.5 )

county_plot

```
