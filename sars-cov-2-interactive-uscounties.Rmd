---
title: "SARS-CoV-2 among US counties"
author: "Chris Berg"
date: <br>`r format(Sys.Date() , "%d %B %Y")`
output: 
  html_document:
    theme: yeti
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

if(!require(pacman)) install.packages("pacman")
pacman::p_load( tidyverse ,  
                sf , 
                lubridate ,
                tigris ,
                leaflet ,
                RColorBrewer )

recent_date = format(Sys.Date() , "%m-%d-%Y")

```

## US counties

```{r datasets, include=F}


options(tigris_class = "sf")
us_counties_map = 
  tigris::counties(cb = T ) 


most_recent_data = 
  readRDS( paste0("data/export/us-county-data-updated-" , Sys.Date() , ".rds" ,sep = "")
  ) %>%
  filter( last_update == recent_date ) %>%
  mutate( GEOID = ifelse( fips < 10000 , 
                          paste(0,fips,sep="") , 
                          fips ) 
          ) %>%
  select(GEOID , confirmed, deaths )


us_counties = 
  left_join( most_recent_data , us_counties_map ) %>%
  st_as_sf()

```

The maps below use recently-available, comprehensive public data on Coronavirus (AKA SARS-CoV-2; COVID-19; 2019-nCoV) cases and deaths among the United States counties . These maps are fully-interactive; one can zoom, pan, and click on the US counties to see their confirmed case counts and death counts.

*Note: Deaths in New York City are (inexplicably) rendered for Manhattan island, not for the other boroughs. Zoom in on the island to check the NYC case and death counts.*

Updated as of `r format(Sys.Date() , "%d %B %Y")`.


## Confirmed Coronavirus cases in US counties


```{r casesmap, echo=FALSE}


col_pal_cases <- colorNumeric(palette = "YlOrRd", domain = log(1+us_counties$confirmed), n = 10)

cases_plot = 
  us_counties %>%
  st_transform(crs = "+init=epsg:4326") %>%
  leaflet(width = "100%") %>% 
  addProviderTiles(provider = "CartoDB.Positron") %>%
  addPolygons(
    popup = ~paste0(NAME, "<br>", "Confirmed cases: ", prettyNum(confirmed, big.mark=",")),
    stroke = FALSE,
    smoothFactor = 0,
    fillOpacity = 0.7,
    color = ~col_pal_cases(log(1+confirmed))
  ) %>%
  addLegend(
    "bottomright", 
    pal = col_pal_cases, 
    values = ~log(1+confirmed),
    title = "Confirmed Cases (Logarithm)",
    opacity = 1
  ) %>% 
  setView(lat=40, lng=-95, zoom=3.5 )

cases_plot

```

## Deaths from Coronavirus in US counties

```{r deathsmap, echo=FALSE}


col_pal_deaths <- colorNumeric(palette = "YlOrRd", domain = log(1+us_counties$deaths), n = 10)

deaths_plot = 
  us_counties %>%
  st_transform(crs = "+init=epsg:4326") %>%
  leaflet(width = "100%") %>% 
  addProviderTiles(provider = "CartoDB.Positron") %>%
  addPolygons(
    popup = ~paste0(NAME, "<br>", "Deaths: ", prettyNum(deaths, big.mark=",")),
    stroke = FALSE,
    smoothFactor = 0,
    fillOpacity = 0.7,
    color = ~col_pal_deaths(log(1+deaths))
  ) %>%
  addLegend(
    "bottomright", 
    pal = col_pal_deaths, 
    values = ~log(1+deaths),
    title = "Deaths (Logarithm)",
    opacity = 1
  ) %>% 
  setView(lat=40, lng=-95, zoom=3.5 )

deaths_plot
```